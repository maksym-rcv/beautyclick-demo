@using System.Configuration
@using System.Web.Mvc.Html
@using Site.Extentions
@using Site.Helper

@model Site.Models.Salon.MasterCalendarModel
@{
    ViewBag.Title = "Calendar";
    var generatedId = Guid.NewGuid();
    Layout = "~/Views/Shared/_LayoutSalon.cshtml";
}

<link rel="stylesheet" href="/css/font-awesome.min.css">

<script>
    // Facebook CheckBox plugin onclick event
    function confirmOptIn() {
        $("#btnAddMessenger").hide();
        FB.AppEvents.logEvent('MessengerCheckboxUserConfirmation', null, {
            'app_id': '451287236164981',
            'page_id': '103467518684626',
            'ref': 'master_@User.GetSecurityCode()',
            'user_ref':'@generatedId'
        });
        setTimeout(function () { location.reload(); }, 2000); // reload page
    }
</script>

<main class="page__master-schedule-new">
    <div class="container">
        <section class="master-schedule">

            @if (Model.DayToEndOfSubscription <= 5)
            {
                <div class="warning">
                    <div class="message">
                        <span>Vaše predplatné sa konči o @Model.DayToEndOfSubscription dní.</span>
                    </div>
                </div>
            }

            @{
                var today = DateTime.UtcNow;

                bool isSmsPayed = true;
                var daysToPayForSms = 0;
                foreach (var payment in DBManager.Subscription.SubscriptionDbManager.Instance.GetPayments(Model.MasterId))
                {
                    if (!payment.IsPaid && payment.PaymentType == 3)
                    {
                        isSmsPayed = false;
                        daysToPayForSms = 7 - (today - payment.CreatedUtc).Days;
                    }
                }
                if (!isSmsPayed)
                {
                    var datumSplatnosti = daysToPayForSms <= 0 ? "vyprší o 0 dní! Váš účet bude zablokovaný do uhradenia faktúry!" : "vyprší o " + daysToPayForSms + " dní!";
                    <div class="warning">
                        <div class="message">
                            <span>
                                Máte faktúru za využité SMS notifikácie. Splatnosť faktúry @datumSplatnosti
                            </span>
                            <a href="/SalonOwner/Payments" class="btn">Platby</a>
                        </div>
                    </div>
                }
            }

            @Html.HiddenFor(m => m.MasterId, new { @id = "hdMaster" })
            @Html.HiddenFor(m => m.SalonId, new { @id = "hdSalon" })
            @{today = DateTime.UtcNow.AddHours(int.Parse(ConfigurationManager.AppSettings["UtcShiftHours"]));}
            @{var todayDate = DateTime.Now.ToString("yyyy-MM-dd");}

            <input type="hidden" id="selected__serviceId" />
            <input type="hidden" id="new_reservation_booked__service" />
            <input type="hidden" id="selected_clientId" />
            <input type="hidden" id="hdBookDate" value="@todayDate" />
            <input type="hidden" id="hdTime" />

            <input type="hidden" id="curDay" value="@today.Day" />
            <input type="hidden" id="curMonth" value="@today.Month" />
            <input type="hidden" id="curYear" value="@today.Year" />
            <input type="hidden" id="hdMovingBooking" />

            <div class="calendar" id="frmcalbok">

                @if (User.IsFacebookActivated() == false && User.CheckViberActivationOnlyMasterOrSolo() == false)
                {
                    <div style="text-align:center;margin:20px auto">
                        <a href="viber://pa?chatURI=@System.Configuration.ConfigurationManager.AppSettings["ViberUri"]&context=master_@User.GetSecurityCode()">
                            Pripojiť Viber <img src="/images/src/viber_icon.png" style="width:25px" />
                        </a>
                    </div>
                }

                <div style="background-color:#d9d9d9; padding:5px; flex-flow:wrap; display:flex; width:100%">
                    <div style="width:68%">
                        <span>Skopírujte a pošlite zákazníkovi link na vašu prevádzku.</span>
                    </div>
                    <div style="width:32%">
                        <button onclick="copylink()"><span>Click TU</span></button>
                    </div>

                    <div style="width:68%">
                        <span>Pozrite si video-inštrukciu:<br />Ako fungujú objednávky.</span>
                    </div>
                    <div style="width:32%">
                        <button id="showVideobutton"><span>Click TU</span></button>
                    </div>

                    <div style="width:68%">
                        <span>Zrušiť naraz viac objednávok</span>
                    </div>
                    <div style="width:32%">
                        <button class="cancelBook"><span>Click TU</span></button>
                    </div>
                </div>

                <div style="text-align:center">
                    <a href="/master/Clients/@Model.MasterId" class="btn">Zoznam zákazníkov</a>
                </div>

                <div id="calendar_inside">
                    @{ Html.RenderPartial("_MasterCalendar", Model.BookSchedule); }
                </div>

                @{ if (Model.NotConfirmedBookedCount > 0)
                    {
                        <div id="notConfirmedReservationsBtn" style="text-align:center">
                            <a href="#masterSchedule" class="btn notConfirmedReservations">Nepotvrdené objednávky (@Model.NotConfirmedBookedCount)</a>
                        </div>
                    }
                }

                <div id="newclientorder" style="text-align:center">
                    <a href="#" class="newReservation btn">Nová objednávka</a>
                </div>
            </div>

            <div class="schedule">
                <div style="max-width:700px;width:100%;padding:15px">
                    <ul class="month__list">
                        <li style="display:block">
                            <div style="text-align:center">
                                <span class="date" id="spanDay">@Model.BookSchedule.Date.Day.@Model.BookSchedule.Date.Month.ToString("00").@Model.BookSchedule.Date.Year</span>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="wrap-table">
                    <table class="schedule__table--new">
                        <tbody id="masterSchedule" class="schedule__table--new fe">
                            @{ Html.RenderPartial("_MasterSchedule", Model.MasterScheduleModel); }
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
</main>


<div id="booked__popup" class="popup protected">
    <div class="overlay"></div>
    <div class="popup__form">
        <div class="title-wpap">
            <h2 class="top-title">Rezervácia klienta</h2>
            <div class="booked__time">
                <input type="hidden" id="hdY" value="@Model.BookSchedule.Date.Year" />
                <input type="hidden" id="hdD" value="@Model.BookSchedule.Date.Day" />
                <input type="hidden" id="hdM" value="@Model.BookSchedule.Date.Month" />
                <span class="date" id="spSchedDate">@Model.BookSchedule.Date.Day.@Model.BookSchedule.Date.Month.@Model.BookSchedule.Date.Year</span> / <span class="time" id="spSchedTime"></span>
            </div>
        </div>

        <button class="close-btn addschedclose"><span></span></button>

        <form class="popup-form__booked" id="frmMasterSched" action="" method="POST">
            <div class="input__wrap">
                <label for="booked__phone">Telefónne číslo <span style="background-color:#EC405D; color:#fff; padding:0 3px">v tvare 09..</span></label>
                <input id="booked__phone" name="Phone" type="text" pattern="09[0-9]{2}-[0-9]{3}-[0-9]{3}" class="nocopy" autocomplete="off" minlenth="12" oninvalid="this.setCustomValidity('@Resources.General.FieldValidator')" oninput="setCustomValidity('')" placeholder="Telefónne číslo" required="" maxlength="16">
            </div>

            <div class="input__wrap">
                <label for="booked__name">Meno a priezvisko</label>
                <input id="booked__name" type="name" oninvalid="this.setCustomValidity('@Resources.General.FieldValidator')" oninput="setCustomValidity('')" name="name" placeholder="Meno a priezvisko" required>
            </div>
            <input type="hidden" id="hdUserId" value="0" />

            <label for="booked__service">Služba</label>
            <div class="input__wrap select">
                @Html.DropDownListFor(m => m.ServiceItems, Model.ServiceItems, new
                {
               id = "booked__service",
               required = "",
               name = "booked__service",
               oninvalid = "this.setCustomValidity('" + @Resources.General.FieldValidator + "')",
               oninput = "setCustomValidity('')"
                })
            </div>
            <button class="btn" id="btnAddBook" type="submit">Uložiť</button>
        </form>
    </div>
</div>

<div id="cancelbooked__popup" class="popup">
    <div class="overlay"></div>
    <div class="popup__form">
        <div class="title-wpap" style="margin:0">
            <h2 class="top-title" style="margin:0 auto 10px">Zrušiť všetko v tento deň</h2>
        </div>
        <button class="close-btn cancelbookclose"><span></span></button>
        <form class="popup-form__booked" id="frmCancelBooking" action="" method="POST">
            <div id="frmCancelBookingDays"></div>
            <button class="btn" style="margin-top:10px" id="btnCancelbook" type="submit">Zrušiť</button>
        </form>
    </div>
</div>

<div id="detailbooked__popup" class="popup details__popup">
    <div class="overlay"></div>
    <div class="popup__form">
        <button class="close-btn detschedclose">
            <span></span>
        </button>
        <div class="inner">
            <h6>Detaily rezervácie</h6>
            <input type="hidden" id="hdDetBookId" />
            <input type="hidden" id="hdVUserId" value="0" />
            <input type="hidden" id="hdDetDate" value="@Model.BookSchedule.Date.Day.@Model.BookSchedule.Date.Month.@Model.BookSchedule.Date.Year" />
            <div class="master">
                <img src="" id="schedDetCusAva" alt="" class="photo">
                <div class="master__description">
                    <span class="name" id="booked__Detname"></span>
                    <span class="tel" id="booked__Detphone"></span>
                </div>
            </div>
            <div class="details_phone_button" id="details_phone_button"></div>
            <ul class="salon__service-list booking">
                <li class="salon__service">
                    <table class="table__service">
                        <tbody>
                            <tr>
                                <th>Služba: </th>
                                <td><span id="booked__Detservice"></span></td>
                            </tr>
                            <tr>
                                <th>Dátum: </th>
                                <td>
                                    <span class="booking-date" id="spDetSchedDay"></span> <span class="booking-month" id="spDetSchedMonth"></span>
                                </td>
                            </tr>
                            <tr>
                                <th>Čas: </th>
                                <td>
                                    <span id="spDetSchedTime"></span>
                                </td>
                            </tr>
                            <tr id="trDetailedClientComment">
                                <th colspan="2"><span id="spClientComment"></span></th>
                            </tr>
                        </tbody>
                    </table>
                </li>
            </ul>
            <div class="details_poznamka" id="details_poznamka"></div>
            <div class="btns">
                <button class="btn" id="btnAproveCustomerBooking" type="submit">Potvrdiť rezerváciu</button>
                <button class="btn" id="btnChangeCustomerBooking" type="submit">Zmeniť rezerváciu</button>
                <button class="btn" id="btnCancelCustomerBooking" type="submit">Zrušiť rezerváciu</button>
            </div>
        </div>
    </div>
</div>

<div id="video__popup" class="popup">
    <div id="video_overlay" class="overlay"></div>
    <div class="enter__form" style="max-width:1000px;padding:0">
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/IYBSp3HhXSk?controls=0&rel=0" title="Ako používať systém rezervácie BeautyClick?" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>
</div>

<div id="facebook__popup" class="popup">
    <div class="overlay"></div>
    <div class="popup__form" style="padding:20px">
        <button class="close-btn facebookPopupClose"><span></span></button>

        <div style="text-align:center">
            <section class="enter__form" style="padding:0;background:transparent;box-shadow:none">
                <h2>Ako pripojiť messenger?</h2>
                <p style="text-align:left;margin:0;line-height:1.5em;font-weight:normal;font-size:14px">
                    1. Zakliknite <img src="/images/src/send-to-messenger.png" style="height:30px;border-radius:5px" /> --> Iba ak nie ste prihlásený na webe FB, vyskočí okno prihlásenia na FB.<br />
                    2. Prihláste sa v ňom, potom znova zakliknite <img src="/images/src/send-to-messenger.png" style="height:30px;border-radius:5px" /> a stalčte pripojiť messenger.
                </p>

                <div class="fb-messenger-checkbox"
                     origin="https://beautyclick.sk"
                     page_id="103467518684626"
                     messenger_app_id="451287236164981"
                     user_ref="@generatedId"
                     allow_login="true"
                     size="large"
                     skin="light"
                     center_align="true">
                </div>
                <input type="button" onclick="confirmOptIn()" value="Pripojiť Messenger" id="btnAddMessenger" class="btn" />
            </section>
        </div>
    </div>
</div>


<div id="dvSchedMonth">
</div>


<script type="text/javascript">
    function copylink() {
        navigator.clipboard.writeText('https://beautyclick.sk/Salon/' + $("#hdSalon").val())
            .then(() => {
                successMsg("Link bol skopirovany");
            })
            .catch(err => {

            });
    }

    $(document).ready(function () {
        $("#booked__service").val('-1');
        var isAModelbox= '@User.IsInRole(Role.SalonAdmin)';

        var isFacebookActivated = '@User.IsFacebookActivated()';
        if (isFacebookActivated == 'False')
        {
            $("#facebook__popup").toggleClass("show");
        }

        $("#new_reservation_client_name").autocomplete({
            source: function (request, response) {
                var f = false;
                var options = $('#dtNameVsComment option');

                $(options).each(function () {
                    if (this.label.toLocaleLowerCase() === request.term.toLocaleString() || (this.label === request.term)) {
                        f = true;
                        $("#hdSelClientVal").val($(this).data('id'));
                        var phoneFormatted = $(this).data('val').substring(0, 4) + '-' + $(this).data('val').substring(4, 7) + '-' + $(this).data('val').substring(7, 10);
                        $("#new_reservation_client_phone").val(phoneFormatted);
                    }
                });
                if (!f) {
                    $('#dtNameVsComment').empty();
                    $.ajax({
                        url: '/Home/ClientNameAutocomplete',
                        datatype: "json",
                        data: {
                            term: request.term,
                            salonId: $("#hdSalon").val() === "" ? 0 : $("#hdSalon").val()
                        },
                        success: function (data) {
                            $.each(data,
                                function (index, value) {
                                    $('#dtNameVsComment').append('<option data-val="' + value.Value + '" data-id="' + value.Id + '">' + value.Name + '</option>');
                                });
                        }
                    });
                }
            },
            select: function (event, ui) {
                console.log(event);
                console.log(ui.item);
                $("#CustomerID").val(ui.item.customerId);
            }
        });
    });

    $(document).on('click', '#showVideobutton', function (e) {
        e.preventDefault();
        $("#video__popup").toggleClass("show");
    });

    document.getElementById("video_overlay").onclick = function (e) {
        var e = e || window.event;
        var target = e.target || e.srcElement;
        if (this == target) {
            $("#video__popup").toggleClass("show");
        }
    }

    $("#booked__phone").change(function (e) {
        if ($(this).val().length != 16) {
            $("#booked__name" ).prop( "disabled", false);
            return;
        }
        $("#hdUserId").val('');
        $("#booked__name").val('');
        $.ajax({
            url: '/Master/FindUser?phone=' + $(this).val(),
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function (data) {
                if (data.isExist) {
                    $("#booked__name").val(data.Name);
                    $("#booked__name").prop("disabled", true);
                    $("#hdUserId").val(data.Id);
                } else {
                    $("#booked__name" ).prop( "disabled", false);
                }
            },
            error: function (xhr) {
            }
        });
    });

    $(document).on("submit", "#frmMasterSched", function (e) {
        e.preventDefault();

        var data = {
            masterId: $("#hdMaster").val(),
            clientName: $("#booked__name").val(),
            clientPhone: $("#booked__phone").val(),
            serviceId: $("#booked__service").val(),
            date: $("#spSchedDate").html(),
            time: $("#spSchedTime").html(),
            salonId: $("#hdSalon").val(),
            customerId: $("#hdUserId").val(),
            serviceName: $("#booked__service option:selected").text()
        };

        $.post("/Master/AddSchedule", { json: data })
            .done(function (result) {
                if (result.IsSuccess) {
                    $("#booked__popup").toggleClass("show");
                    successMsg(result.Message);

                    // update current calendar state
                    loadSchedule($("#hdD").val(), $("#hdM").val(), $("#hdY").val(), $("#hdMaster").val());
                    $("#hdUserId").val('');
                } else {
                    $.alert({
                        title: 'Chyba!',
                        content: result.Message
                    });
                }
            })
            .fail(function (xhr, status, error) {
            });
    });

    $(document).on("click", ".timeSel", function (e) {
        $(".timeSelBtn").removeClass("active");
        e.preventDefault();

        $("#hdTime").val($(this).data("time"));
        console.log($(this).first(".timeSelBtn"));
        $(this).find(">:first-child").addClass("active");
    });

    function booking(obj, e) {
        e.preventDefault();
        if ($("#hdTime").val() === undefined || $("#hdTime").val() === null || $("#hdTime").val().length <= 0) {
            errorMsgC('Chyba! Vyberte čas');
            return;
        }
        var data = {
            masterId: $("#hdMaster").val(),
            clientName: $("#new_reservation_client_name").val(),
            clientPhone: $("#new_reservation_client_phone").val(),
            serviceId: $("#new_reservation_booked__service").val(),
            date: $("#spSchedDate").html(),
            time: $("#hdTime").val(),
            salonId: $("#hdSalon").val(),
            customerId: $("#hdUserId").val(),
            serviceName: $("#new_reservation_booked__service option:selected").text()
        };

        $.post("/Master/AddSchedule", { json: data })
        .done(function (result) {
            if (result.IsSuccess) {
                successMsg(result.Message);

                $(".timeSelBtn").removeClass("active");
                $("#hdTime").val("");

                loadSchedule($("#hdD").val(), $("#hdM").val(), $("#hdY").val(), $("#hdMaster").val());
                $("#hdUserId").val('');
            } else {
                $.alert({ title: 'Chyba!', content: result.Message });
            }
        })
        .fail(function (xhr, status, error) {
             location.reload();
        });
    }

    function loadCalendarMaster(m, y, master, service, day = 1) {
        $.ajax({
            url: '/Home/GetBookCalendarMaster?month=' + m + "&year=" + y + "&day=" + day + "&master=" + ((master === undefined || master === null) ? 0 : master) +
                "&service=" + ((service === undefined || service === null) ? 0 : service),
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function (data) {
                loadSlot(master, service, m, y, day);
                $("#dvSchedMonth").html(data);
            },
            error: function (xhr) {

            }
        });
    }

    $(document).on("click", ".mstCalNotEx", function(e) {
        $.confirm({
            title: '',
            backgroundDismiss: true,
            escapeKey: true,
            content: 'Tento deň chýba vo vašom rozvruhu. chcete teraz otvoriť rozvrh?',
            buttons: {
                nie: function () {

                },
                ano: function() {
                    location.href = '/SalonOwner/MasterSchedule/' + '@Model.MasterId';
                }
            }
        });
    });

    $(document).on("click", ".free", function (e) {
        e.preventDefault();

        if ($("#hdMovingBooking").val().length > 0) {
            return MoveBooking($("#hdMovingBooking").val(), $(this).data("time"), $("#spSchedDate").html());
        }

        Swal.fire({
            title: '',
            html: 'Nastaviť ako prestávku',
            text: "",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Áno',
            cancelButtonColor: 'gray',
            cancelButtonText: 'Nie'
        }).then((result) => {
            if (result.isConfirmed) {
                var data = {
                    date: $("#spSchedDate").html(),
                    time: $(this).data("time"),
                    SalonId: $("#hdSalon").val(),
                    MasterId: $("#hdMaster").val()
                };
                $.post("/Master/CloseSlot", { data: data })
                    .done(function (result) {
                        if (result.IsSuccess) {
                            successMsg(result.Message);
                            loadSchedule($("#hdD").val(), $("#hdM").val(), $("#hdY").val(), $("#hdMaster").val());
                        }
                        return;
                    })
                    .fail(function (xhr, status, error) {
                    });
            }
        });
    });

    $(".addschedclose").click(function(e) {
        $("#booked__popup").toggleClass("show");
    });

    $(".detschedclose").click(function(e) {
        $("#detailbooked__popup").toggleClass("show");
    });
    $(".cancelbookclose").click(function(e) {
        $("#cancelbooked__popup").toggleClass("show");
    });

    $(".showFacebookPopup").click(function (e) {
        e.preventDefault();
        $("#facebook__popup").toggleClass("show");
    });
    $(".facebookPopupClose").click(function (e) {
        $("#facebook__popup").toggleClass("show");
    });

    function loadCalendar(m, y, master, service) {
        $.ajax({
            url: '/Master/GetBookCalendar?month=' +
                m +
                "&year=" +
                y +
                "&master=" +
                ((master === undefined || master === null) ? 0 : master) +
                "&service=" +
                ((service === undefined || service === null) ? 0 : service),
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function(data) {
                loadSlot(master, 0, m, y, 1);
                $("#calendar_inside").html(data);
                loadSchedule($("#curDay").val(), $("#curMonth").val(), $("#curYear").val(), master);
            },
            error: function(xhr) {
            }
        });
    }

    function loadSlot(master, service, m, y,d) {
        var url = '/Home/GetMasterFreeSlotsNew?ser=' + service + "&master=" + master + "&date=" + y + "-" + m + "-" + d + "&bookId=" + $("#hdDetBookId").val();
        window.$.ajax({
            url: url,
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function(data) {
                window.$("#dvTimeSlots").html(data.Html);
            },
            error: function(xhr) {
                alert('error');
            }
        });
    }

    function loadMasterSlots() {
        var url = '/Home/GetMasterFreeSlotsNew?ser=' + $("#new_reservation_booked__service").val() + "&master=" + $("#hdMaster").val() + "&date=" + $("#hdBookDate").val() + "&bookId=" + $("#hdDetBookId").val();
        var date = window.$("#hdBookDate").val();
        $("#hdcurDay").val(date.split('-')[2]);
        window.$.ajax({
            url: url,
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function (data) {
                window.$("#dvTimeSlots").html(data.Html);
            },
            error: function (xhr) {
                alert('error');
            }
        });
    }

    // Nepotvrdené objednávky
    $(document).on("click", ".notConfirmedReservations", function (e) {
        //var dt = "-- . -- . ----";
        $("#spanDay").html("");
        loadNotConfirmedReservations($("#hdMaster").val());
    });

    function loadNotConfirmedReservations(master) {
        $.ajax({
            url: '/Master/GetNotConfirmedReservations?masterid=' + master,
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function (data) {
                $("#masterSchedule").html(data);
            },
            error: function (xhr) {

            }
        });
    }

    // Switch date in the main calendar
    $(document).on("click", ".rdbt", function (e) {
        var dt = $(this).data("day") + '.' + $(this).data("month") + '.' + $(this).data("year");
        $("#spanDay").html(dt);
        $("#spSchedDate").html(dt);
        $("#hdY").val($(this).data("year"));
        $("#hdM").val($(this).data("month"));
        $("#hdD").val($(this).data("day"));
        $("#curMonth").val($(this).data("month"));
        $("#curYear").val($(this).data("year"));
        $("#curDay").val($(this).data("day"));

        $(".timeSel").removeClass("active");
        $(this).toggleClass("active");

        loadSchedule($(this).data("day"), $(this).data("month"), $(this).data("year"), $("#hdMaster").val());
    });

    function loadSchedule(d, m, y, master) {
        $.ajax({
            url: '/Master/GetMasterDay?masterid=' + master + '&day=' + d + '&month=' + m + "&year=" + y,
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function (data) {
                $("#masterSchedule").html(data);
            },
            error: function (xhr) {

            }
        });
    }

    function backToCalendar() {
        var masterId = $("#hdMaster").val();
        var d = $("#hdD").val();
        $.ajax({
            url: '/Master/GetMasterDay?masterid=' + $("#hdMaster").val() + '&day=' + $("#hdD").val() + '&month=' + $("#hdM").val() + "&year=" + $("#hdY").val(),
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function (data) {
                $("#masterSchedule").html(data);
            },
            error: function (xhr) {

            }
        });
    }

    $(".cancelBook").click(function (e) {
        var en = '@User.IsInRole(Role.Master)';
        var sl = '@User.GetSoloMasterStatus()';
        var sa = '@User.IsInRole(Role.SalonAdmin)';
        if (en === 'False' && sl === 'False' && sa === 'False') {
            return false;
        }
        e.preventDefault();

        $.ajax({
            url: '/Master/GetCancelDatesCalendar?month=' + $("#curMonth").val() + "&year=" + $("#curYear").val() + "&master=" + $("#hdMaster").val(),
            datatype: "json",
            type: "get",
            contenttype: 'application/json; charset=utf-8',
            async: true,
            success: function (data) {
                $("#frmCancelBookingDays").html(data);
                $("#cancelbooked__popup").toggleClass("show");
            },
            error: function (xhr) {
                alert('error');
            }
        });
    });

    $("#btnCancelbook").click(function (e) {
        e.preventDefault();
        var en = '@User.IsInRole(Role.Master)';
        var sl = '@User.GetSoloMasterStatus()';
        var sa = '@User.IsInRole(Role.SalonAdmin)';
        if (en === 'False' && sl === 'False' && sa === 'False') {
            return false;
        }

        var total = $('.wrap-inner input:checkbox:checked').length;
        if (total <= 0) {
            $.alert({
                title: 'Vyberte aspoň jeden deň!',
                content: ''
            });
            return;
        }
        Swal.fire({
            title: '',
            html: 'Naozaj chcete zrušiť všetky rezervácie v tieto dni? Zmena bude konečná.',
            text: "",
            icon: 'error',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Potvrdzujem!',
            cancelButtonText: 'Nie, nechcem',
        }).then((result) => {
            if (result.isConfirmed) {
                var days = [];
                $('input[id^="cnlBk_"]:checkbox:checked').each(function (index) {
                    var d = new Object();
                    var day = $(this).data("day");
                    var mon = $(this).data("month");
                    var year = $(this).data("year");
                    d.Day = day;
                    d.Month = mon;
                    d.Year = year;
                    days.push(d);
                });

                $.post("/Master/CancelDays", { json: JSON.stringify(days), masterId: $("#hdMaster").val() })
                    .done(function (result) {
                        if (result.IsSuccess) {
                            successMsg(result.Message);
                            $("input[id^='cnlBk_']").prop("checked", false);
                            $("#cancelbooked__popup").toggleClass("show");
                            loadSchedule($("#hdD").val(), $("#hdM").val(), $("#hdY").val(), $("#hdMaster").val());
                        }
                        else {
                            $.alert({
                                title: 'Chyba!',
                                content: result.Message
                            });
                        }
                        return;
                    })
                    .fail(function (xhr, status, error) {
                    });
            }
            if (!result.isConfirmed) {
                $("input[id^='cnlBk_']").prop("checked", false);
                $("#cancelbooked__popup").toggleClass("show");
            }
        });
    });

    $(document).on("click", ".openSlot",
        function (e) {
            e.preventDefault();

            var en = '@User.IsInRole(Role.Master)';
            var sl = '@User.GetSoloMasterStatus()';
            var sa = '@User.IsInRole(Role.SalonAdmin)';
            if (en === 'False' && sl === 'False' && sa === 'False') {
                return false;
            }

            Swal.fire({
                title: '',
                html: 'Chcete otvoriť tento čas pre rezervácie?',
                text: "",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Potvrdzujem!',
                cancelButtonText: 'Nie, nechcem'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Master/OpenSlot?slotId='+$(this).data("slotid") + "&masterId="+$("#hdMaster").val(),
                        datatype: "json",
                        type: "get",
                        contenttype: 'application/json; charset=utf-8',
                        async: true,
                        success: function (data) {
                            loadSchedule($("#hdD").val(), $("#hdM").val(), $("#hdY").val(), $("#hdMaster").val());
                        },
                        error: function (xhr) {

                        }
                    });
                    loadSchedule($("#hdD").val(), $("#hdM").val(), $("#hdY").val(), $("#hdMaster").val());
                }
            });
        });

    $(document).on("click", ".bookedSlot", function(e) {
        e.preventDefault();

        var en = '@User.IsInRole(Role.Master)';
        var sl = '@User.GetSoloMasterStatus()';
        var sa = '@User.IsInRole(Role.SalonAdmin)';
        if (en === 'False' && sl === 'False' && sa === 'False') { return false; }

        $("#spDetSchedDay").html($(this).data("day"));
        $("#spDetSchedMonth").html($(this).data("month"));
        $("#spDetSchedTime").html($(this).data("time"));
        $("#booked__Detname").html($(this).data("name"));
        $("#hdDetDate").val($(this).data("scheddate"));
        var phone = $(this).data("phone");
        if (phone[0] == '0') {
            var telUrl = "<a href='tel:+421" + phone.substring(1, phone.length) + "'>" + $(this).data("phone") + "</a>";
            $("#booked__Detphone").html(telUrl);
            var phoneButtonHtml = "<a href='tel:+421" + phone.substring(1, phone.length) + "' class='btn' style='background:#4ec42c'><i aria-hidden='true'></i> Zavolať</a>";
            $("#details_phone_button").html(phoneButtonHtml);
        } else {
            $("#booked__Detphone").html("");
            $("#details_phone_button").html("");
        }

        if ($(this).data("servicename") != '.') {
            $("#booked__Detservice").html($(this).data("servicename"));
        } else {
            $("#booked__Detservice").html($(this).data("comment"));
        }

        $("#selected__serviceId").val($(this).data("serviceid"));
        $("#new_reservation_booked__service").val($(this).data("serviceid"));
        $("#new_reservation_client_phone").val($(this).data("phone"));
        $("#hdUserId").val($(this).data("clientid"));

        $("#hdDetBookId").val($(this).data("slotid"));
        $("#detailbooked__popup").toggleClass("show");

        if ($(this).hasClass("confirmed")) {
            if (!$("#btnAproveCustomerBooking").hasClass("hidden")) {
                $("#btnAproveCustomerBooking").addClass("hidden");
            }
        } else {
            if ($("#btnAproveCustomerBooking").hasClass("hidden")) {
                $("#btnAproveCustomerBooking").removeClass("hidden");
            }
        }

        var clientComment = $(this).find(".poznamka-klienta").html();
        if (clientComment) {
            if (clientComment.length > 0) {
                if ($("#trDetailedClientComment").hasClass("hidden"))
                    $("#trDetailedClientComment").removeClass("hidden");
                $("#spClientComment").html(clientComment);
            } else {
                $("#trDetailedClientComment").addClass("hidden");
            }
        } else {
            $("#spClientComment").html("");
            $("#trDetailedClientComment").addClass("hidden");
        }

        $("#schedDetCusAva").attr("src", $(this).data("ava"));
    });

    $("#btnAproveCustomerBooking").click(function (e) {
        e.preventDefault();

        var en = '@User.IsInRole(Role.Master)';
        var sl = '@User.GetSoloMasterStatus()';
        var sa = '@User.IsInRole(Role.SalonAdmin)';
        if (en === 'False' && sl === 'False' && sa === 'False') { return false; }

        $.post("/Master/AproveCustomerBooking", { slotId: $("#hdDetBookId").val(), masterId: $("#hdMaster").val() })
            .done(function (result) {
                if (result.IsSuccess) {
                    successMsg(result.Message);
                    location.reload();
                } else {
                    errorMsg(result.Message);
                }
                $("#detailbooked__popup").toggleClass("show");
            })
            .fail(function (xhr, status, error) {
            });
    });

    $("#btnCancelCustomerBooking").click(function(e) {
        e.preventDefault();
        var en = '@User.IsInRole(Role.Master)';
        var sl = '@User.GetSoloMasterStatus()';
        var sa = '@User.IsInRole(Role.SalonAdmin)';
        if (en === 'False' && sl === 'False' && sa === 'False') {
            return false;
        }

        Swal.fire({
            title: '',
            html: 'Naozaj chcete zrušiť rezerváciu?',
            text: "",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            denyButtonColor: '#d33',
            cancelButtonColor: 'gray',
            confirmButtonText: 'Potvrdzujem!',
            cancelButtonText: 'Nie, nechcem',
        }).then((result) => {
            if (!result.isConfirmed) {
                return;
            }

            if (result.isConfirmed) {
                $.post("/Master/CancelCustomerBooking", { slotId: $("#hdDetBookId").val(), MasterId: $("#hdMaster").val() /*data: data*/})
                    .done(function (result) {
                        if (result.IsSuccess) {
                            successMsg(result.Message);
                            loadSchedule($("#hdD").val(), $("#hdM").val(), $("#hdY").val(), $("#hdMaster").val());
                        } else {
                            errorMsg(result.Message);
                        }
                        $("#detailbooked__popup").toggleClass("show");
                        return;
                    })
                    .fail(function (xhr, status, error) {
                    });
            }
        });
    });

    $('#booked__phone').mask("0000-000-000", { placeholder: "09xx-xxx-xxx" });
    $('#new_reservation_client_phone').mask("0000-000-000", { placeholder: "09xx-xxx-xxx" });
    $('#booked__Detphone').mask("0000-000-000", { placeholder: "09xx-xxx-xxx" });

</script>
